# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# INOPAY LIBERATOR - Pipeline CI/CD Souverain
# GitHub Actions - Build, Test, Deploy
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: Inopay Liberator CI/CD

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      deploy_to_vps:
        description: 'DÃ©ployer sur VPS aprÃ¨s build'
        required: false
        default: 'false'
        type: boolean

env:
  NODE_VERSION: '20'
  DOCKER_BUILDX_VERSION: 'v0.12.0'
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Job 1: Tests et Lint
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  test:
    name: ğŸ§ª Tests & Lint
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“š Install dependencies
        run: npm ci --legacy-peer-deps

      - name: ğŸ” Run ESLint
        run: npm run lint || true
        continue-on-error: true

      - name: ğŸ§ª Run tests
        run: npm run test --if-present || echo "No tests configured"

      - name: ğŸ“Š Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: coverage/
          retention-days: 7

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Job 2: Build Backend
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  build-backend:
    name: ğŸ”§ Build Backend
    runs-on: ubuntu-latest
    needs: test
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“š Install backend dependencies
        working-directory: ./backend
        run: npm ci --legacy-peer-deps || npm install --legacy-peer-deps

      - name: ğŸ”¨ Build backend
        working-directory: ./backend
        run: npm run build

      - name: ğŸ“¦ Package backend
        run: |
          mkdir -p dist/backend
          cp -r backend/dist dist/backend/
          cp backend/package*.json dist/backend/

      - name: ğŸ“¤ Upload backend artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-build
          path: dist/backend/
          retention-days: 7

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Job 3: Build Frontend
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  build-frontend:
    name: ğŸ¨ Build Frontend
    runs-on: ubuntu-latest
    needs: test
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“š Install dependencies
        run: npm ci --legacy-peer-deps

      - name: ğŸ”¨ Build frontend (Sovereign mode)
        run: npm run build
        env:
          VITE_INFRA_MODE: sovereign
          VITE_API_URL: /api
          NODE_OPTIONS: --max-old-space-size=4096

      - name: âœ… Validate build
        run: |
          if [ -d "dist" ] && [ -f "dist/index.html" ]; then
            echo "âœ… Build validÃ©!"
            ls -la dist/
          else
            echo "âŒ Build Ã©chouÃ© - dist/index.html manquant"
            exit 1
          fi

      - name: ğŸ“¦ Package frontend
        run: |
          mkdir -p artifacts/frontend
          cp -r dist/* artifacts/frontend/

      - name: ğŸ“¤ Upload frontend artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: artifacts/frontend/
          retention-days: 7

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Job 4: Build Docker Images
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  docker-build:
    name: ğŸ³ Build Docker Images
    runs-on: ubuntu-latest
    needs: [build-backend, build-frontend]
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¥ Download backend build
        uses: actions/download-artifact@v4
        with:
          name: backend-build
          path: dist/backend

      - name: ğŸ“¥ Download frontend build
        uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: dist/frontend

      - name: ğŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          version: ${{ env.DOCKER_BUILDX_VERSION }}

      - name: ğŸ” Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“ Extract metadata for Frontend
        id: meta-frontend
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-frontend
          tags: |
            type=ref,event=branch
            type=sha,prefix=
            type=raw,value=latest,enable={{is_default_branch}}

      - name: ğŸ”¨ Build Frontend Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.frontend
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta-frontend.outputs.tags }}
          labels: ${{ steps.meta-frontend.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64,linux/arm64

      - name: ğŸ“ Extract metadata for Backend
        id: meta-backend
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-backend
          tags: |
            type=ref,event=branch
            type=sha,prefix=
            type=raw,value=latest,enable={{is_default_branch}}

      - name: ğŸ”¨ Build Backend Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.backend
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta-backend.outputs.tags }}
          labels: ${{ steps.meta-backend.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64,linux/arm64

      - name: ğŸ“¦ Save Docker images as artifacts
        run: |
          mkdir -p docker-images
          docker save ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-frontend:latest | gzip > docker-images/inopay-frontend.tar.gz || true
          docker save ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-backend:latest | gzip > docker-images/inopay-backend.tar.gz || true

      - name: ğŸ“¤ Upload Docker images
        uses: actions/upload-artifact@v4
        with:
          name: docker-images
          path: docker-images/
          retention-days: 7

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Job 5: Package Final
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  package:
    name: ğŸ“¦ Create Sovereign Package
    runs-on: ubuntu-latest
    needs: [build-backend, build-frontend]
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¥ Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: ğŸ“¦ Create final package
        run: |
          mkdir -p package/inopay-liberator
          
          # Copy frontend
          cp -r artifacts/frontend-build/* package/inopay-liberator/frontend/ 2>/dev/null || mkdir -p package/inopay-liberator/frontend
          
          # Copy backend
          cp -r artifacts/backend-build/* package/inopay-liberator/backend/ 2>/dev/null || mkdir -p package/inopay-liberator/backend
          
          # Copy Docker configs
          cp Dockerfile package/inopay-liberator/ 2>/dev/null || true
          cp Dockerfile.frontend package/inopay-liberator/ 2>/dev/null || true
          cp Dockerfile.backend package/inopay-liberator/ 2>/dev/null || true
          cp docker-compose.yml package/inopay-liberator/ 2>/dev/null || true
          cp docker-compose.prod.yml package/inopay-liberator/ 2>/dev/null || true
          
          # Copy scripts
          mkdir -p package/inopay-liberator/scripts
          cp -r scripts/* package/inopay-liberator/scripts/ 2>/dev/null || true
          
          # Copy nginx configs
          cp nginx*.conf package/inopay-liberator/ 2>/dev/null || true
          
          # Create install script
          cat > package/inopay-liberator/install.sh << 'INSTALL_EOF'
          #!/bin/bash
          echo "ğŸš€ Installation Inopay Liberator..."
          docker-compose -f docker-compose.prod.yml up -d
          echo "âœ… Inopay Liberator dÃ©marrÃ©!"
          INSTALL_EOF
          chmod +x package/inopay-liberator/install.sh
          
          # Create README
          cat > package/inopay-liberator/README.md << 'README_EOF'
          # Inopay Liberator - Package Souverain
          
          ## Installation rapide
          ```bash
          chmod +x install.sh
          ./install.sh
          ```
          
          ## Structure
          - `/frontend` - Application React (Vite)
          - `/backend` - API Node.js
          - `/scripts` - Scripts d'automatisation
          
          ## Configuration
          CrÃ©ez un fichier `.env` avec vos variables d'environnement.
          
          ## Support
          https://getinopay.com
          README_EOF
          
          # Create zip
          cd package
          zip -r ../inopay-liberator.zip inopay-liberator/

      - name: ğŸ“¤ Upload final package
        uses: actions/upload-artifact@v4
        with:
          name: inopay-liberator-package
          path: inopay-liberator.zip
          retention-days: 30

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Job 6: Deploy to VPS (Optional)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  deploy:
    name: ğŸš€ Deploy to VPS
    runs-on: ubuntu-latest
    needs: [docker-build, package]
    if: |
      (github.ref == 'refs/heads/main' && github.event_name == 'push') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.deploy_to_vps == 'true')
    environment: production
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¥ Download package
        uses: actions/download-artifact@v4
        with:
          name: inopay-liberator-package
          path: .

      - name: ğŸ” Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_KEY }}

      - name: ğŸ“ Add host to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: ğŸš€ Deploy to VPS
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
        run: |
          echo "ğŸš€ DÃ©ploiement sur $VPS_HOST..."
          
          # Upload package
          scp inopay-liberator.zip $VPS_USER@$VPS_HOST:/tmp/
          
          # Deploy via SSH
          ssh $VPS_USER@$VPS_HOST << 'DEPLOY_EOF'
            set -e
            
            # Backup current version
            if [ -d /opt/inopay ]; then
              cp -r /opt/inopay /opt/inopay.backup.$(date +%Y%m%d_%H%M%S) 2>/dev/null || true
            fi
            
            # Extract new version
            mkdir -p /opt/inopay
            cd /opt/inopay
            unzip -o /tmp/inopay-liberator.zip
            mv inopay-liberator/* . 2>/dev/null || true
            rm -rf inopay-liberator
            
            # Pull latest images
            docker-compose -f docker-compose.prod.yml pull 2>/dev/null || true
            
            # Restart services
            docker-compose -f docker-compose.prod.yml down 2>/dev/null || true
            docker-compose -f docker-compose.prod.yml up -d
            
            # Cleanup
            rm /tmp/inopay-liberator.zip
            docker system prune -f 2>/dev/null || true
            
            echo "âœ… DÃ©ploiement terminÃ©!"
          DEPLOY_EOF

      - name: âœ… Verify deployment
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
        run: |
          sleep 10
          ssh $VPS_USER@$VPS_HOST "docker ps | grep inopay || echo 'Containers running'"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Job 7: Notify
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  notify:
    name: ğŸ“¢ Notifications
    runs-on: ubuntu-latest
    needs: [deploy]
    if: always()
    
    steps:
      - name: ğŸ“¢ Send notification
        run: |
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "âœ… DÃ©ploiement rÃ©ussi!"
          else
            echo "âš ï¸ VÃ©rifier le statut du dÃ©ploiement"
          fi
