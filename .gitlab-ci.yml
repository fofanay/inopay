# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# INOPAY LIBERATOR - GitLab CI/CD Pipeline
# Souverain - Compatible Docker in Docker
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

image: node:20-alpine

variables:
  NODE_VERSION: "20"
  DOCKER_HOST: tcp://docker:2376
  DOCKER_TLS_CERTDIR: "/certs"
  DOCKER_TLS_VERIFY: 1
  DOCKER_CERT_PATH: "$DOCKER_TLS_CERTDIR/client"
  FF_USE_FASTZIP: "true"
  ARTIFACT_COMPRESSION_LEVEL: "fast"
  CACHE_COMPRESSION_LEVEL: "fast"
  GIT_DEPTH: 10

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Stages
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
stages:
  - test
  - build
  - dockerize
  - package
  - deploy

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Cache global
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - node_modules/
    - .npm/
  policy: pull-push

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Templates
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
.node_template: &node_template
  before_script:
    - npm ci --cache .npm --prefer-offline --legacy-peer-deps

.docker_template: &docker_template
  image: docker:24-dind
  services:
    - docker:24-dind
  before_script:
    - docker info
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY 2>/dev/null || true

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Stage: Test
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
lint:
  stage: test
  <<: *node_template
  script:
    - npm run lint || true
  allow_failure: true
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

test:
  stage: test
  <<: *node_template
  script:
    - npm run test --if-present || echo "No tests configured"
  coverage: '/All files[^|]*\|[^|]*\s+([\d\.]+)/'
  artifacts:
    when: always
    reports:
      junit: coverage/junit.xml
      coverage_report:
        coverage_format: cobertura
        path: coverage/cobertura-coverage.xml
    paths:
      - coverage/
    expire_in: 7 days
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

security-scan:
  stage: test
  image: node:20-alpine
  script:
    - npm audit --audit-level=high || true
  allow_failure: true
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Stage: Build
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
build-frontend:
  stage: build
  <<: *node_template
  script:
    - echo "ğŸ¨ Building frontend..."
    - npm run build
    - |
      if [ -d "dist" ] && [ -f "dist/index.html" ]; then
        echo "âœ… Frontend build successful!"
        ls -la dist/
      else
        echo "âŒ Frontend build failed!"
        exit 1
      fi
  variables:
    VITE_INFRA_MODE: sovereign
    VITE_API_URL: /api
    NODE_OPTIONS: --max-old-space-size=4096
  artifacts:
    paths:
      - dist/
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

build-backend:
  stage: build
  <<: *node_template
  script:
    - echo "ğŸ”§ Building backend..."
    - cd backend
    - npm ci --legacy-peer-deps || npm install --legacy-peer-deps
    - npm run build
    - echo "âœ… Backend build successful!"
  artifacts:
    paths:
      - backend/dist/
      - backend/package*.json
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Stage: Dockerize
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
docker-frontend:
  stage: dockerize
  <<: *docker_template
  needs:
    - build-frontend
  script:
    - echo "ğŸ³ Building frontend Docker image..."
    - docker build -t $CI_REGISTRY_IMAGE/frontend:$CI_COMMIT_SHA -f Dockerfile.frontend .
    - docker tag $CI_REGISTRY_IMAGE/frontend:$CI_COMMIT_SHA $CI_REGISTRY_IMAGE/frontend:latest
    - docker push $CI_REGISTRY_IMAGE/frontend:$CI_COMMIT_SHA || true
    - docker push $CI_REGISTRY_IMAGE/frontend:latest || true
    - docker save $CI_REGISTRY_IMAGE/frontend:latest | gzip > inopay-frontend.tar.gz
  artifacts:
    paths:
      - inopay-frontend.tar.gz
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

docker-backend:
  stage: dockerize
  <<: *docker_template
  needs:
    - build-backend
  script:
    - echo "ğŸ³ Building backend Docker image..."
    - docker build -t $CI_REGISTRY_IMAGE/backend:$CI_COMMIT_SHA -f Dockerfile.backend .
    - docker tag $CI_REGISTRY_IMAGE/backend:$CI_COMMIT_SHA $CI_REGISTRY_IMAGE/backend:latest
    - docker push $CI_REGISTRY_IMAGE/backend:$CI_COMMIT_SHA || true
    - docker push $CI_REGISTRY_IMAGE/backend:latest || true
    - docker save $CI_REGISTRY_IMAGE/backend:latest | gzip > inopay-backend.tar.gz
  artifacts:
    paths:
      - inopay-backend.tar.gz
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Stage: Package
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
package:
  stage: package
  image: alpine:latest
  needs:
    - build-frontend
    - build-backend
    - docker-frontend
    - docker-backend
  before_script:
    - apk add --no-cache zip
  script:
    - echo "ğŸ“¦ Creating sovereign package..."
    - mkdir -p package/inopay-liberator
    
    # Copy builds
    - cp -r dist package/inopay-liberator/frontend 2>/dev/null || mkdir -p package/inopay-liberator/frontend
    - cp -r backend/dist package/inopay-liberator/backend 2>/dev/null || mkdir -p package/inopay-liberator/backend
    - cp backend/package*.json package/inopay-liberator/backend/ 2>/dev/null || true
    
    # Copy Docker configs
    - cp Dockerfile* package/inopay-liberator/ 2>/dev/null || true
    - cp docker-compose*.yml package/inopay-liberator/ 2>/dev/null || true
    - cp nginx*.conf package/inopay-liberator/ 2>/dev/null || true
    
    # Copy scripts
    - mkdir -p package/inopay-liberator/scripts
    - cp -r scripts/* package/inopay-liberator/scripts/ 2>/dev/null || true
    
    # Copy Docker images
    - cp *.tar.gz package/inopay-liberator/ 2>/dev/null || true
    
    # Create install script
    - |
      cat > package/inopay-liberator/install.sh << 'EOF'
      #!/bin/bash
      set -e
      echo "ğŸš€ Installation Inopay Liberator..."
      
      # Load Docker images if present
      for img in *.tar.gz; do
        [ -f "$img" ] && docker load -i "$img" && echo "âœ… Image $img chargÃ©e"
      done
      
      # Start services
      docker-compose -f docker-compose.prod.yml up -d
      
      echo "âœ… Inopay Liberator dÃ©marrÃ©!"
      echo "ğŸŒ AccÃ¨s: http://localhost:80"
      EOF
    - chmod +x package/inopay-liberator/install.sh
    
    # Create README
    - |
      cat > package/inopay-liberator/README.md << 'EOF'
      # Inopay Liberator - Package Souverain
      
      ## Installation
      ```bash
      chmod +x install.sh
      ./install.sh
      ```
      
      ## Contenu
      - Frontend React (Vite)
      - Backend Node.js
      - Images Docker prÃ©-construites
      - Scripts d'automatisation
      
      ## Support
      https://getinopay.com
      EOF
    
    # Create final zip
    - cd package
    - zip -r ../inopay-liberator.zip inopay-liberator/
    - cd ..
    - ls -lh inopay-liberator.zip
  artifacts:
    name: "inopay-liberator-${CI_COMMIT_SHORT_SHA}"
    paths:
      - inopay-liberator.zip
    expire_in: 30 days
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Stage: Deploy
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
deploy-staging:
  stage: deploy
  image: alpine:latest
  needs:
    - package
  before_script:
    - apk add --no-cache openssh-client
    - mkdir -p ~/.ssh
    - echo "$VPS_SSH_KEY" | tr -d '\r' > ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
    - ssh-keyscan -H $VPS_HOST >> ~/.ssh/known_hosts 2>/dev/null || true
  script:
    - echo "ğŸš€ Deploying to staging..."
    - scp inopay-liberator.zip $VPS_USER@$VPS_HOST:/tmp/
    - |
      ssh $VPS_USER@$VPS_HOST << 'EOF'
        set -e
        
        # Backup
        [ -d /opt/inopay ] && cp -r /opt/inopay /opt/inopay.backup.$(date +%Y%m%d) 2>/dev/null || true
        
        # Deploy
        mkdir -p /opt/inopay
        cd /opt/inopay
        unzip -o /tmp/inopay-liberator.zip
        mv inopay-liberator/* . 2>/dev/null || true
        rm -rf inopay-liberator
        
        # Restart
        chmod +x install.sh
        ./install.sh
        
        # Cleanup
        rm /tmp/inopay-liberator.zip
        docker system prune -f 2>/dev/null || true
        
        echo "âœ… Staging deployment complete!"
      EOF
  environment:
    name: staging
    url: https://staging.getinopay.com
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      when: manual
  allow_failure: true

deploy-production:
  stage: deploy
  image: alpine:latest
  needs:
    - package
    - deploy-staging
  before_script:
    - apk add --no-cache openssh-client
    - mkdir -p ~/.ssh
    - echo "$PROD_SSH_KEY" | tr -d '\r' > ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
    - ssh-keyscan -H $PROD_HOST >> ~/.ssh/known_hosts 2>/dev/null || true
  script:
    - echo "ğŸš€ Deploying to production..."
    - scp inopay-liberator.zip $PROD_USER@$PROD_HOST:/tmp/
    - |
      ssh $PROD_USER@$PROD_HOST << 'EOF'
        set -e
        
        # Backup
        [ -d /opt/inopay ] && cp -r /opt/inopay /opt/inopay.backup.$(date +%Y%m%d) 2>/dev/null || true
        
        # Deploy
        mkdir -p /opt/inopay
        cd /opt/inopay
        unzip -o /tmp/inopay-liberator.zip
        mv inopay-liberator/* . 2>/dev/null || true
        rm -rf inopay-liberator
        
        # Restart with zero-downtime
        docker-compose -f docker-compose.prod.yml pull
        docker-compose -f docker-compose.prod.yml up -d --remove-orphans
        
        # Cleanup
        rm /tmp/inopay-liberator.zip
        docker system prune -f 2>/dev/null || true
        
        echo "âœ… Production deployment complete!"
      EOF
  environment:
    name: production
    url: https://getinopay.com
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      when: manual
  allow_failure: false

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Cleanup
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
cleanup:
  stage: .post
  image: docker:24-dind
  services:
    - docker:24-dind
  script:
    - docker system prune -af 2>/dev/null || true
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      when: always
  allow_failure: true
